<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KODNEST BANK - AI Assistant</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 40px;
            width: 100%;
            max-width: 450px;
        }

        .auth-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo i {
            font-size: 70px;
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
            padding: 20px;
            border-radius: 50%;
            border: 2px solid #f59e0b;
        }

        .auth-title {
            color: white;
            text-align: center;
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .auth-subtitle {
            color: #94a3b8;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
        }

        .input-group i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 18px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #334155;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group select {
            padding: 15px 15px 15px 45px;
            cursor: pointer;
            appearance: none;
        }

        .input-group select option {
            background: #1e293b;
            color: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }

        .auth-footer {
            text-align: center;
            margin-top: 25px;
            color: #94a3b8;
        }

        .auth-footer a {
            color: #f59e0b;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            margin-left: 5px;
        }

        .auth-footer a:hover {
            text-decoration: underline;
        }

        .dashboard {
            width: 100%;
            max-width: 1200px;
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info i {
            font-size: 40px;
            color: #f59e0b;
        }

        .user-details h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #94a3b8;
            font-size: 14px;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .ai-assistant {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-bottom: 30px;
            height: 450px;
        }

        .ai-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            background: rgba(0, 0, 0, 0.2);
        }

        .ai-header i {
            font-size: 24px;
            color: #f59e0b;
        }

        .ai-header h3 {
            font-size: 18px;
        }

        .ai-header span {
            color: #94a3b8;
            font-size: 14px;
            margin-left: auto;
        }

        .ai-chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ai-message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .ai-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(245, 158, 11, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f59e0b;
            flex-shrink: 0;
            font-size: 16px;
        }

        .ai-avatar.user {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .ai-bubble {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 12px 16px;
            color: white;
            font-size: 14px;
            line-height: 1.6;
            max-width: calc(100% - 50px);
            white-space: pre-wrap;
        }

        .ai-bubble.user-bubble {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: bounce 1.5s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .ai-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .ai-input-wrapper {
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 30px;
            padding: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-input-wrapper input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 18px;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .ai-input-wrapper input::placeholder {
            color: #94a3b8;
        }

        .ai-input-wrapper button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #f59e0b;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .ai-input-wrapper button:hover {
            background: #d97706;
            transform: scale(1.05);
        }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .action-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .action-card:hover {
            transform: translateY(-5px);
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }

        .action-card i {
            font-size: 40px;
            color: #f59e0b;
            margin-bottom: 15px;
        }

        .action-card h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .action-card p {
            color: #94a3b8;
            font-size: 14px;
        }

        .database-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            color: white;
        }

        .database-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #f59e0b;
            font-size: 20px;
        }

        .database-table {
            width: 100%;
            border-collapse: collapse;
        }

        .database-table th {
            text-align: left;
            padding: 12px;
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            font-weight: 600;
            font-size: 14px;
        }

        .database-table td {
            padding: 12px;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
            font-size: 14px;
        }

        .database-table tr:hover td {
            background: rgba(255, 255, 255, 0.05);
        }

        .encrypted-badge {
            background: #334155;
            color: #94a3b8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            border: 1px solid #334155;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
        }

        .modal-header i {
            font-size: 24px;
            color: #f59e0b;
        }

        .close-btn {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirm-btn {
            background: #f59e0b;
            color: white;
        }

        .cancel-btn {
            background: #334155;
            color: white;
        }

        .confirm-btn:hover {
            background: #d97706;
        }

        .cancel-btn:hover {
            background: #475569;
        }

        .balance-display {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            color: white;
        }

        .balance-display h2 {
            font-size: 42px;
            margin-top: 10px;
        }

        .recipient-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .recipient-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: all 0.3s;
        }

        .recipient-item:hover {
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
        }

        .recipient-item:last-child {
            border-bottom: none;
        }

        .recipient-item i {
            color: #f59e0b;
            width: 30px;
            text-align: center;
        }

        .recipient-info {
            flex: 1;
        }

        .recipient-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .recipient-email {
            color: #94a3b8;
            font-size: 12px;
        }

        .transactions {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            color: white;
            margin-bottom: 30px;
        }

        .transactions h3 {
            margin-bottom: 15px;
            color: #f59e0b;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #334155;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info p {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .transaction-info small {
            color: #94a3b8;
        }

        .transaction-amount {
            color: #ef4444;
            font-weight: 600;
        }

        .transaction-amount.credit {
            color: #10b981;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #1e293b;
            color: white;
            border-radius: 10px;
            border-left: 4px solid #f59e0b;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 2000;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div id="toast" class="toast"></div>

    <!-- Login Page -->
    <div id="loginPage" class="auth-wrapper">
        <div class="glass-card">
            <div class="auth-logo">
                <i class="fas fa-landmark"></i>
            </div>
            <h1 class="auth-title">KODNEST BANK</h1>
            <p class="auth-subtitle">Secure Banking Platform</p>

            <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="loginEmail" placeholder="Email Address" value="om@kodnest.com">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="loginPassword" placeholder="Password" value="onkar123">
            </div>
            
            <button class="auth-button" onclick="handleLogin()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div class="auth-footer">
                <span>New to KODNEST?</span>
                <a onclick="showRegister()">Create Account</a>
            </div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="auth-wrapper" style="display: none;">
        <div class="glass-card">
            <div class="auth-logo">
                <i class="fas fa-user-plus"></i>
            </div>
            <h1 class="auth-title">KODNEST BANK</h1>
            <p class="auth-subtitle">Join KODNEST today</p>

            <div class="input-group">
                <i class="fas fa-user"></i>
                <input type="text" id="regName" placeholder="Full Name">
            </div>
            <div class="input-group">
                <i class="fas fa-envelope"></i>
                <input type="email" id="regEmail" placeholder="Email Address">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="regPassword" placeholder="Password">
            </div>
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="regConfirmPassword" placeholder="Confirm Password">
            </div>
            
            <button class="auth-button" onclick="handleRegister()">
                <i class="fas fa-user-plus"></i> Register
            </button>

            <div class="auth-footer">
                <span>Already have an account?</span>
                <a onclick="showLogin()">Login</a>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <div class="dashboard-header">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <div class="user-details">
                    <h3 id="userName"></h3>
                    <p id="userEmail"></p>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- AI ASSISTANT -->
        <div class="ai-assistant">
            <div class="ai-header">
                <i class="fas fa-robot"></i>
                <h3>KODNEST Bank Assistant</h3>
                <span><i class="fas fa-circle" style="color: #10b981; font-size: 10px;"></i> Online</span>
            </div>
            
            <div class="ai-chat-area" id="aiChatArea">
                <!-- Messages will appear here -->
            </div>

            <div class="ai-input-area">
                <div class="ai-input-wrapper">
                    <input type="text" id="aiInput" placeholder="Ask me anything..." autofocus>
                    <button onclick="sendAIMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Cards -->
        <div class="action-cards">
            <div class="action-card" onclick="openCheckBalanceModal()">
                <i class="fas fa-eye"></i>
                <h3>Check Balance</h3>
                <p>View your account balance</p>
            </div>
            <div class="action-card" onclick="openTransferModal()">
                <i class="fas fa-exchange-alt"></i>
                <h3>Transfer Money</h3>
                <p>Send money to others</p>
            </div>
        </div>

        <!-- Quick Transfer -->
        <div class="database-section">
            <div class="database-header">
                <i class="fas fa-users"></i>
                <h3>Quick Transfer - Select Recipient</h3>
            </div>
            <div class="recipient-list" id="recipientList">
                <!-- Filled by JavaScript -->
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="transactions">
            <h3><i class="fas fa-history"></i> Recent Transactions</h3>
            <div id="transactionsList">
                <p style="text-align: center; padding: 20px; color: #94a3b8;">
                    No transactions yet
                </p>
            </div>
        </div>

        <!-- DATABASE VIEW -->
        <div class="database-section">
            <div class="database-header">
                <i class="fas fa-database"></i>
                <h3>KODNEST Users Database</h3>
                <span class="encrypted-badge">Encrypted</span>
            </div>
            <table class="database-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Password (Encrypted)</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody id="databaseBody">
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Check Balance Modal -->
    <div id="balanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <i class="fas fa-lock" style="margin-right: 10px;"></i>
                    <span>Verify Identity</span>
                </div>
                <button class="close-btn" onclick="closeBalanceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #94a3b8; margin-bottom: 20px;">Enter your credentials to view balance</p>
                <div class="input-group" style="margin-bottom: 15px;">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="verifyEmail" placeholder="Your Email">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="verifyPassword" placeholder="Your Password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeBalanceModal()">Cancel</button>
                <button class="confirm-btn" onclick="verifyAndShowBalance()">Verify & View</button>
            </div>
        </div>
    </div>

    <!-- Balance Display Modal -->
    <div id="balanceDisplayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <i class="fas fa-wallet" style="margin-right: 10px; color: #10b981;"></i>
                    <span>Your Balance</span>
                </div>
                <button class="close-btn" onclick="closeBalanceDisplayModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="balance-display">
                    <p>Current Balance</p>
                    <h2 id="displayBalanceAmount">₹0</h2>
                </div>
            </div>
            <div class="modal-footer">
                <button class="confirm-btn" onclick="closeBalanceDisplayModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <i class="fas fa-exchange-alt" style="margin-right: 10px;"></i>
                    <span>Transfer Money</span>
                </div>
                <button class="close-btn" onclick="closeTransferModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group" style="margin-bottom: 15px;">
                    <i class="fas fa-envelope"></i>
                    <select id="transferToEmail">
                        <option value="">Select Recipient</option>
                        <!-- Filled by JavaScript -->
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 15px;">
                    <i class="fas fa-rupee-sign"></i>
                    <input type="number" id="transferAmount" placeholder="Amount (₹)">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="transferPassword" placeholder="Your Password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" onclick="closeTransferModal()">Cancel</button>
                <button class="confirm-btn" onclick="processTransfer()">Send Money</button>
            </div>
        </div>
    </div>

    <script>
        // ========== DATABASE (LocalStorage) ==========
        let users = JSON.parse(localStorage.getItem('kodnest_users')) || [];
        let transactions = JSON.parse(localStorage.getItem('kodnest_transactions')) || [];
        let currentUser = null;

        // ========== ENCRYPTION FUNCTION ==========
        async function encryptPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'kodnest_salt_2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // ========== TOAST FUNCTION ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type === 'error' ? 'error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ========== PAGE NAVIGATION ==========
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('dashboard').classList.remove('active');
        }

        function showRegister() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
        }

        // ========== UPDATE DATABASE DISPLAY ==========
        function updateDatabaseDisplay() {
            const tbody = document.getElementById('databaseBody');
            const recipientList = document.getElementById('recipientList');
            const select = document.getElementById('transferToEmail');
            
            if (!tbody) return;
            
            let tbodyHtml = '';
            let recipientHtml = '';
            let selectHtml = '<option value="">Select Recipient</option>';
            
            users.forEach(user => {
                const encryptedPreview = user.password.substring(0, 20) + '...';
                
                tbodyHtml += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span style="color: #94a3b8; font-family: monospace;">${encryptedPreview}</span></td>
                        <td>₹${user.balance.toLocaleString()}</td>
                    </tr>
                `;

                if (currentUser && user.email !== currentUser.email) {
                    recipientHtml += `
                        <div class="recipient-item" onclick="selectRecipient('${user.email}')">
                            <i class="fas fa-user"></i>
                            <div class="recipient-info">
                                <div class="recipient-name">${user.name}</div>
                                <div class="recipient-email">${user.email}</div>
                            </div>
                            <div>₹${user.balance.toLocaleString()}</div>
                        </div>
                    `;

                    selectHtml += `<option value="${user.email}">${user.name} (${user.email})</option>`;
                }
            });

            tbody.innerHTML = tbodyHtml;
            
            if (recipientList) {
                if (recipientHtml) {
                    recipientList.innerHTML = recipientHtml;
                } else {
                    recipientList.innerHTML = '<p style="color: #94a3b8; padding: 20px; text-align: center;">No other users available</p>';
                }
            }

            if (select) {
                select.innerHTML = selectHtml;
            }
        }

        // ========== SELECT RECIPIENT ==========
        function selectRecipient(email) {
            document.getElementById('transferToEmail').value = email;
            openTransferModal();
            showToast(`Recipient selected: ${email}`, 'success');
        }

        // ========== INITIALIZE DEFAULT USERS ==========
        async function initializeDefaultUsers() {
            if (users.length === 0) {
                const password1 = await encryptPassword('onkar123');
                const password2 = await encryptPassword('abhay123');
                const password3 = await encryptPassword('raj123');
                const password4 = await encryptPassword('priya123');
                const password5 = await encryptPassword('amit123');
                
                users = [
                    {
                        id: 1,
                        name: 'Omkar Patil',
                        email: 'om@kodnest.com',
                        password: password1,
                        balance: 500000,
                        created: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Abhaya Sharma',
                        email: 'ab@kodnest.com',
                        password: password2,
                        balance: 600000,
                        created: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'Raj Kumar',
                        email: 'raj@kodnest.com',
                        password: password3,
                        balance: 250000,
                        created: new Date().toISOString()
                    },
                    {
                        id: 4,
                        name: 'Priya Singh',
                        email: 'priya@kodnest.com',
                        password: password4,
                        balance: 350000,
                        created: new Date().toISOString()
                    },
                    {
                        id: 5,
                        name: 'Amit Verma',
                        email: 'amit@kodnest.com',
                        password: password5,
                        balance: 450000,
                        created: new Date().toISOString()
                    }
                ];
                localStorage.setItem('kodnest_users', JSON.stringify(users));
            }
        }

        // ========== REGISTER FUNCTION ==========
        async function handleRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPass = document.getElementById('regConfirmPassword').value;

            if (!name || !email || !password || !confirmPass) {
                showToast('Please fill all fields!', 'error');
                return;
            }

            if (password !== confirmPass) {
                showToast('Passwords do not match!', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters!', 'error');
                return;
            }

            if (users.some(u => u.email === email)) {
                showToast('Email already registered!', 'error');
                return;
            }

            const encryptedPassword = await encryptPassword(password);

            const newUser = {
                id: users.length + 1,
                name: name,
                email: email,
                password: encryptedPassword,
                balance: 100000,
                created: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('kodnest_users', JSON.stringify(users));

            showToast('Registration successful! Please login.', 'success');
            showLogin();
            updateDatabaseDisplay();

            document.getElementById('regName').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
        }

        // ========== LOGIN FUNCTION ==========
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showToast('Please fill all fields!', 'error');
                return;
            }

            const encryptedPassword = await encryptPassword(password);
            const user = users.find(u => u.email === email && u.password === encryptedPassword);

            if (user) {
                currentUser = user;
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                
                updateDatabaseDisplay();
                loadUserTransactions();
                
                // Welcome message
                setTimeout(() => {
                    addAIMessage(`Welcome ${user.name}!`);
                }, 500);
                
                showToast(`Welcome ${user.name}!`, 'success');
                
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            } else {
                showToast('Invalid email or password!', 'error');
            }
        }

        // ========== CHECK BALANCE FUNCTIONS ==========
        function openCheckBalanceModal() {
            document.getElementById('balanceModal').classList.add('active');
            document.getElementById('verifyEmail').value = '';
            document.getElementById('verifyPassword').value = '';
        }

        function closeBalanceModal() {
            document.getElementById('balanceModal').classList.remove('active');
        }

        function closeBalanceDisplayModal() {
            document.getElementById('balanceDisplayModal').classList.remove('active');
        }

        async function verifyAndShowBalance() {
            const email = document.getElementById('verifyEmail').value;
            const password = document.getElementById('verifyPassword').value;

            if (!email || !password) {
                showToast('Please fill all fields!', 'error');
                return;
            }

            const encryptedPassword = await encryptPassword(password);
            const user = users.find(u => u.email === email && u.password === encryptedPassword);

            if (user) {
                document.getElementById('balanceModal').classList.remove('active');
                document.getElementById('displayBalanceAmount').textContent = `₹${user.balance.toLocaleString()}`;
                document.getElementById('balanceDisplayModal').classList.add('active');
                showToast('Identity verified successfully!', 'success');
            } else {
                showToast('Invalid credentials!', 'error');
            }
        }

        // ========== TRANSFER FUNCTIONS ==========
        function openTransferModal() {
            document.getElementById('transferModal').classList.add('active');
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferPassword').value = '';
            
            const select = document.getElementById('transferToEmail');
            let options = '<option value="">Select Recipient</option>';
            users.forEach(user => {
                if (currentUser && user.email !== currentUser.email) {
                    options += `<option value="${user.email}">${user.name} (${user.email})</option>`;
                }
            });
            select.innerHTML = options;
        }

        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('active');
        }

        async function processTransfer() {
            if (!currentUser) {
                showToast('Please login again!', 'error');
                logout();
                return;
            }

            const toEmail = document.getElementById('transferToEmail').value;
            const amount = parseInt(document.getElementById('transferAmount').value);
            const password = document.getElementById('transferPassword').value;

            if (!toEmail || !amount || !password) {
                showToast('Please fill all fields!', 'error');
                return;
            }

            if (amount <= 0) {
                showToast('Invalid amount!', 'error');
                return;
            }

            const encryptedPassword = await encryptPassword(password);
            
            if (encryptedPassword !== currentUser.password) {
                showToast('Incorrect password!', 'error');
                return;
            }

            if (amount > currentUser.balance) {
                showToast('Insufficient balance!', 'error');
                return;
            }

            const recipient = users.find(u => u.email === toEmail);

            if (!recipient) {
                showToast('Recipient not found!', 'error');
                return;
            }

            currentUser.balance -= amount;
            recipient.balance += amount;

            localStorage.setItem('kodnest_users', JSON.stringify(users));

            const transaction = {
                id: transactions.length + 1,
                fromEmail: currentUser.email,
                fromName: currentUser.name,
                toEmail: recipient.email,
                toName: recipient.name,
                amount: amount,
                date: new Date().toISOString(),
                type: 'debit'
            };

            transactions.push(transaction);
            localStorage.setItem('kodnest_transactions', JSON.stringify(transactions));

            closeTransferModal();
            updateDatabaseDisplay();
            loadUserTransactions();
            
            showToast(`₹${amount.toLocaleString()} sent to ${recipient.name}!`, 'success');
        }

        // ========== LOAD TRANSACTIONS ==========
        function loadUserTransactions() {
            if (!currentUser) return;

            const userTransactions = transactions
                .filter(t => t.fromEmail === currentUser.email || t.toEmail === currentUser.email)
                .reverse()
                .slice(0, 5);

            const transactionsDiv = document.getElementById('transactionsList');

            if (userTransactions.length === 0) {
                transactionsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #94a3b8;">No transactions yet</p>';
                return;
            }

            let html = '';
            userTransactions.forEach(t => {
                const isDebit = t.fromEmail === currentUser.email;
                const otherParty = isDebit ? t.toName : t.fromName;
                const date = new Date(t.date).toLocaleString();

                html += `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <p>${isDebit ? 'Sent to' : 'Received from'} ${otherParty}</p>
                            <small>${date}</small>
                        </div>
                        <div class="transaction-amount ${isDebit ? '' : 'credit'}">
                            ${isDebit ? '-₹' : '+₹'}${t.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            });

            transactionsDiv.innerHTML = html;
        }

        // ========== LOGOUT ==========
        function logout() {
            currentUser = null;
            document.getElementById('dashboard').classList.remove('active');
            showLogin();
            showToast('Logged out successfully!', 'success');
        }

        // ========== AI FUNCTIONS ==========
        function addAIMessage(text, isUser = false) {
            const chatArea = document.getElementById('aiChatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = `ai-avatar ${isUser ? 'user' : ''}`;
            avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const bubble = document.createElement('div');
            bubble.className = `ai-bubble ${isUser ? 'user-bubble' : ''}`;
            
            const p = document.createElement('p');
            p.textContent = text;
            bubble.appendChild(p);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showTypingIndicator() {
            const chatArea = document.getElementById('aiChatArea');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-bubble">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingElem = document.getElementById('typingIndicator');
            if (typingElem) typingElem.remove();
        }

        // FIXED: AI Response Function - GREETINGS WORK NOW!
        function getAIResponse(question) {
            const q = question.toLowerCase().trim();
            
            // FIXED: GREETINGS - Now catches ALL variations
            if (q === 'hi' || q === 'hello' || q === 'hey' || q === 'hii' || q === 'hlo' || q === 'helo' || q === 'hy') {
                return `Hi ${currentUser ? currentUser.name : 'there'}!`;
            }
            
            if (q.includes('good morning')) {
                return `Good morning ${currentUser ? currentUser.name : 'there'}!`;
            }
            
            if (q.includes('good afternoon')) {
                return `Good afternoon ${currentUser ? currentUser.name : 'there'}!`;
            }
            
            if (q.includes('good evening')) {
                return `Good evening ${currentUser ? currentUser.name : 'there'}!`;
            }
            
            if (q.includes('how are you')) {
                return "I'm doing well, thank you!";
            }
            
            // ===== YOUR ACCOUNT INFO =====
            if (q.includes('balance') || q.includes('how much money')) {
                return `Your current balance is ₹${currentUser.balance.toLocaleString()}.`;
            }
            
            if (q.includes('my name')) {
                return `Your name is ${currentUser.name}.`;
            }
            
            if (q.includes('my email')) {
                return `Your email is ${currentUser.email}.`;
            }
            
            // ===== TRANSACTIONS =====
            if (q.includes('transaction') || q.includes('history')) {
                const userTransactions = transactions.filter(t => t.fromEmail === currentUser.email || t.toEmail === currentUser.email);
                
                if (userTransactions.length === 0) {
                    return "You don't have any transactions yet.";
                }
                
                let response = "Your recent transactions:\n";
                userTransactions.slice(0, 3).forEach((t, index) => {
                    const isDebit = t.fromEmail === currentUser.email;
                    const otherParty = isDebit ? t.toName : t.fromName;
                    const amount = isDebit ? `-₹${t.amount.toLocaleString()}` : `+₹${t.amount.toLocaleString()}`;
                    response += `${index+1}. ${isDebit ? 'Sent to' : 'Received from'} ${otherParty}: ${amount}\n`;
                });
                
                return response;
            }
            
            // ===== OTHER USERS =====
            if (q.includes('how many users')) {
                return `There are ${users.length} registered users.`;
            }
            
            if (q.includes('total bank balance')) {
                const total = users.reduce((sum, user) => sum + user.balance, 0);
                return `Total bank balance is ₹${total.toLocaleString()}.`;
            }
            
            // ===== DEFAULT =====
            return "I don't understand that question.";
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            // Add user message
            addAIMessage(text, true);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Get response after a short delay
            setTimeout(() => {
                removeTypingIndicator();
                const response = getAIResponse(text);
                addAIMessage(response);
            }, 800);
        }

        // Allow Enter key to send
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'aiInput' && e.key === 'Enter') {
                e.preventDefault();
                sendAIMessage();
            }
        });

        // ========== INITIALIZE ==========
        window.onload = async function() {
            await initializeDefaultUsers();
            showLogin();
            updateDatabaseDisplay();
        };
    </script>
</body>
</html>